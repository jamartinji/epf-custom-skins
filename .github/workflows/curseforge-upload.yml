# Build addon zip and upload to CurseForge (WoW).
# Triggers: (1) when you publish a GitHub Release → runs; (2) manually from Actions → Run workflow.
# Required secrets: CURSEFORGE_API_TOKEN, CURSEFORGE_PROJECT_ID, CURSEFORGE_GAME_VERSION_IDS

name: CurseForge Upload

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (shown from .toc; edit to override)'
        required: true
        default: 'from .toc'
      changelog:
        description: 'Changelog (shown from changelog.txt; edit to override)'
        required: false
        default: 'from changelog.txt'

env:
  ADDON_NAME: ElitePlayerFrame_Enhacned_CustomSkins

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version and changelog
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "${{ github.event.release.tag_name }}" | sed 's/^v//' > version.txt
            echo "${{ github.event.release.body }}" > changelog.txt
          else
            TOC="ElitePlayerFrame_Enhacned_CustomSkins.toc"
            VERSION_INPUT="${{ github.event.inputs.version }}"
            if [ -n "$VERSION_INPUT" ] && [ "$VERSION_INPUT" != "from .toc" ]; then
              echo "$VERSION_INPUT" > version.txt
              echo "Using version from input: $VERSION_INPUT"
            else
              VERSION=$(grep -E '^\s*##\s*Version\s*:' "$TOC" | sed 's/.*Version\s*:\s*//' | tr -d ' \r\n')
              if [ -z "$VERSION" ]; then
                echo "::error::Could not read version from $TOC."
                exit 1
              fi
              echo "$VERSION" > version.txt
              echo "Read version from .toc: $VERSION"
            fi
            CHANGELOG_INPUT="${{ github.event.inputs.changelog }}"
            if [ -n "$CHANGELOG_INPUT" ] && [ "$CHANGELOG_INPUT" != "from changelog.txt" ]; then
              echo "$CHANGELOG_INPUT" > changelog.txt
            elif [ -f "changelog.txt" ]; then
              echo "Using changelog.txt from repo"
            else
              echo "See release notes." > changelog.txt
            fi
          fi
          echo "version=$(cat version.txt)" >> $GITHUB_OUTPUT

      - name: Create zip
        run: |
          mkdir -p build/${{ env.ADDON_NAME }}
          rsync -a \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.idea' \
            --exclude='.gitignore' \
            --exclude='build' \
            --exclude='*.psd' \
            --exclude='version.txt' \
            --exclude='changelog.txt' \
            ./ build/${{ env.ADDON_NAME }}/
          mv version.txt build/
          cd build && zip -r ../${{ env.ADDON_NAME }}-$(cat version.txt).zip ${{ env.ADDON_NAME }}
          cd .. && ls -la *.zip

      # Uploads the correct zip (ElitePlayerFrame_Enhacned_CustomSkins-<version>.zip) to CurseForge.
      # Requires all 3 secrets; if any is missing, this step fails and the upload is not performed.
      - name: Upload to CurseForge
        env:
          CURSEFORGE_API_TOKEN: ${{ secrets.CURSEFORGE_API_TOKEN }}
          CURSEFORGE_PROJECT_ID: ${{ secrets.CURSEFORGE_PROJECT_ID }}
          GAME_VERSION_IDS: ${{ secrets.CURSEFORGE_GAME_VERSION_IDS }}
        run: |
          if [ -z "$CURSEFORGE_API_TOKEN" ] || [ -z "$CURSEFORGE_PROJECT_ID" ] || [ -z "$GAME_VERSION_IDS" ]; then
            echo "Missing secrets. Set CURSEFORGE_API_TOKEN, CURSEFORGE_PROJECT_ID, CURSEFORGE_GAME_VERSION_IDS in repo Settings → Secrets."
            exit 1
          fi
          VERSION=$(cat build/version.txt)
          # gameVersions: comma-separated IDs → JSON array [1234,5678]
          GAME_IDS_JSON="[${GAME_VERSION_IDS}]"
          CHANGELOG_JSON=$(jq -Rs . changelog.txt)
          metadata=$(jq -n \
            --argjson gameVersions "$GAME_IDS_JSON" \
            --argjson changelog "$CHANGELOG_JSON" \
            --arg version "$VERSION" \
            '{changelog: $changelog, changelogType: "markdown", displayName: $version, gameVersions: $gameVersions, releaseType: "release"}')
          curl -sS -X POST \
            -H "X-Api-Token: $CURSEFORGE_API_TOKEN" \
            -F "metadata=$metadata" \
            -F "file=@${{ env.ADDON_NAME }}-${VERSION}.zip" \
            "https://wow.curseforge.com/api/projects/${CURSEFORGE_PROJECT_ID}/upload-file"
          echo ""

      # Copy of the same zip for download; GitHub packages it as addon-<version>.zip when downloaded.
      - name: Upload zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: addon-${{ steps.vars.outputs.version }}
          path: ${{ env.ADDON_NAME }}-${{ steps.vars.outputs.version }}.zip
